# before hitting 'make' you should have a shell with emconfigure and emcc.
# install emscripten and follow instructions here:
#   https://kripken.github.io/emscripten-site/docs/tools_reference/emsdk.html

# for a detailed explanation of compile flags:
# - https://emscripten.org/docs/tools_reference/emcc.html
# - https://github.com/emscripten-core/emscripten/blob/main/src/settings.js

BASE_FLAGS= -s NO_DYNAMIC_EXECUTION=1 \
			-s MODULARIZE=1 \
			-s EXPORT_NAME=newJQ \
			-s ALLOW_MEMORY_GROWTH=1 \
			-s MEMORY_GROWTH_GEOMETRIC_STEP=0.5 \
			-s WASM=1 \
			-s USE_PTHREADS=0 \
			-s INVOKE_RUN=0 \
			-s EXIT_RUNTIME=1 \
			--memory-init-file 0 \
			-O3 \
			-g1 \
			-Wno-unused-command-line-argument \
			--pre-js $(PWD)/pre.js

.PHONY: jq

jq.wasm: jq
	  mkdir -p dist && \
	  mv jq/jq dist/jq.wasm.js && \
	  mv jq/jq.wasm dist/jq.wasm

jq.wasm.min: dist/jq.wasm.js
	  yarn node-minify --compressor uglify-js --input dist/jq.wasm.js --output dist/jq.wasm.min.js

jq: jq/configure
	cd jq && \
	  emconfigure ./configure --disable-maintainer-mode --with-oniguruma=builtin && \
	  make clean && \
	  EMCC_CFLAGS="$(BASE_FLAGS)" emmake make LDFLAGS=-all-static -j4

jq/configure: .gitmodules
	git submodule update --init
	cd jq && \
	  git submodule update --init && \
	  autoreconf -fi

clean:
	rm -f dist/*

test:
	yarn test
